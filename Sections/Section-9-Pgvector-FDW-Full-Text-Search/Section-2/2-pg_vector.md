### [Pg Vector Intro](https://github.com/pgvector/pgvector) 

- create the vector extension in `cbd_store` db :

  ```sql
  -- init.sql
  CREATE EXTENSION vector;
  
  
  ```

  

- create the product table :

  ```sql
  CREATE TABLE product (
      id SERIAL PRIMARY KEY,
      vector_description vector, 
      promised_ce INT,
      stock_level INT,
      category VARCHAR(255),
      title VARCHAR(255),
      brand VARCHAR(255),
      description TEXT
  );
  ```

  

- insert some data : 

  ```sql 
  INSERT INTO product (vector_description, promised_ce, stock_level, category, title, brand, description)
  VALUES 
      ('{1.2, 3.4, 5.6}', 24, 100, 'Electronics', 'Laptop', 'BrandX', 'Powerful laptop for gaming and productivity.'),
      ('{0.8, 2.6, 4.9}', 12, 50, 'Clothing', 'T-shirt', 'FashionCo', 'Comfortable cotton t-shirt for everyday wear.'),
      ('{2.1, 4.3, 6.5}', 36, 80, 'Home & Kitchen', 'Coffee Maker', 'KitchenMaster', 'Automatic coffee maker for brewing fresh coffee.'),
      ('{1.5, 3.8, 7.2}', 48, 120, 'Electronics', 'Smartphone', 'TechGiant', 'Latest smartphone with high-resolution display and powerful processor.'),
      ('{0.9, 2.4, 5.7}', 18, 60, 'Clothing', 'Jeans', 'DenimCo', 'Classic denim jeans with a comfortable fit.'),
      ('{2.3, 4.6, 8.9}', 64, 150, 'Home & Kitchen', 'Blender', 'KitchenMaster', 'Powerful blender for making smoothies and sauces.'),
      ('{1.8, 3.1, 6.4}', 30, 70, 'Electronics', 'Tablet', 'TechGiant', 'Versatile tablet for work and entertainment.'),
      ('{0.7, 2.9, 4.2}', 10, 40, 'Clothing', 'Sweater', 'FashionCo', 'Cozy sweater for chilly days.'),
      ('{2.5, 4.8, 7.1}', 42, 90, 'Home & Kitchen', 'Rice Cooker', 'KitchenMaster', 'Automatic rice cooker for perfectly cooked rice every time.'),
      ('{1.3, 3.6, 5.9}', 28, 80, 'Electronics', 'Smart Watch', 'TechGiant', 'Smart watch with fitness tracking and notification features.');
  
  
  or 
  
  
  
  INSERT INTO product (vector_description, promised_ce, stock_level, category, title, brand, description)
  VALUES
      (ARRAY[1.2, 3.4, 5.6], 24, 100, 'Electronics', 'Laptop', 'BrandX', 'Powerful laptop for gaming and productivity.'),
      (ARRAY[0.8, 2.6, 4.9], 12, 50, 'Clothing', 'T-shirt', 'FashionCo', 'Comfortable cotton t-shirt for everyday wear.'),
      (ARRAY[2.1, 4.3, 6.5], 36, 80, 'Home & Kitchen', 'Coffee Maker', 'KitchenMaster', 'Automatic coffee maker for brewing fresh coffee.'),
      (ARRAY[1.5, 3.8, 7.2], 48, 120, 'Electronics', 'Smartphone', 'TechGiant', 'Latest smartphone with high-resolution display and powerful processor.'),
      (ARRAY[0.9, 2.4, 5.7], 18, 60, 'Clothing', 'Jeans', 'DenimCo', 'Classic denim jeans with a comfortable fit.'),
      (ARRAY[2.3, 4.6, 8.9], 64, 150, 'Home & Kitchen', 'Blender', 'KitchenMaster', 'Powerful blender for making smoothies and sauces.'),
      (ARRAY[1.8, 3.1, 6.4], 30, 70, 'Electronics', 'Tablet', 'TechGiant', 'Versatile tablet for work and entertainment.'),
      (ARRAY[0.7, 2.9, 4.2], 10, 40, 'Clothing', 'Sweater', 'FashionCo', 'Cozy sweater for chilly days.'),
      (ARRAY[2.5, 4.8, 7.1], 42, 90, 'Home & Kitchen', 'Rice Cooker', 'KitchenMaster', 'Automatic rice cooker for perfectly cooked rice every time.'),
      (ARRAY[1.3, 3.6, 5.9], 28, 80, 'Electronics', 'Smart Watch', 'TechGiant', 'Smart watch with fitness tracking and notification features.');
  
  ```

  

- `select * from product`



## Getting Started

Enable the extension (do this once in each database where you want to use it)

```
CREATE EXTENSION vector;
```



Create a vector column with 3 dimensions

```
CREATE TABLE items (id bigserial PRIMARY KEY, embedding vector(3));
```



Insert vectors

```
INSERT INTO items (embedding) VALUES ('[1,2,3]'), ('[4,5,6]');
```



Get the nearest neighbors by L2 distance

```
SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;
```



Also supports inner product (`<#>`) and cosine distance (`<=>`)

Note: `<#>` returns the negative inner product since Postgres only supports `ASC` order index scans on operators

## Storing

Create a new table with a vector column

```
CREATE TABLE items (id bigserial PRIMARY KEY, embedding vector(3));
```



Or add a vector column to an existing table

```
ALTER TABLE items ADD COLUMN embedding vector(3);
```



Insert vectors

```
INSERT INTO items (embedding) VALUES ('[1,2,3]'), ('[4,5,6]');
```



Upsert vectors

```
INSERT INTO items (id, embedding) VALUES (1, '[1,2,3]'), (2, '[4,5,6]')
    ON CONFLICT (id) DO UPDATE SET embedding = EXCLUDED.embedding;
```



Update vectors

```
UPDATE items SET embedding = '[1,2,3]' WHERE id = 1;
```



Delete vectors

```
DELETE FROM items WHERE id = 1;
```



## Querying

Get the nearest neighbors to a vector

```
SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;
```



Get the nearest neighbors to a row

```
SELECT * FROM items WHERE id != 1 ORDER BY embedding <-> (SELECT embedding FROM items WHERE id = 1) LIMIT 5;
```



Get rows within a certain distance

```
SELECT * FROM items WHERE embedding <-> '[3,1,2]' < 5;
```



Note: Combine with `ORDER BY` and `LIMIT` to use an index

#### Distances

Get the distance

```
SELECT embedding <-> '[3,1,2]' AS distance FROM items;
```



For inner product, multiply by -1 (since `<#>` returns the negative inner product)

```
SELECT (embedding <#> '[3,1,2]') * -1 AS inner_product FROM items;
```



For cosine similarity, use 1 - cosine distance

```
SELECT 1 - (embedding <=> '[3,1,2]') AS cosine_similarity FROM items;
```



#### Aggregates

Average vectors

```
SELECT AVG(embedding) FROM items;
```



Average groups of vectors

```
SELECT category_id, AVG(embedding) FROM items GROUP BY category_id;
```



### Practical Samples

```-- Add a new column named vector_description
    ALTER TABLE products ADD COLUMN pgvector_desc vector;
```

- create the embedding of each `seo_desc` using OpenAI/GPT4All/ ...
- store the embedding and start querying ... 





```sql

SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;



SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;


SELECT embedding <-> '[3,1,2]' AS distance FROM items;


SELECT (embedding <#> '[3,1,2]') * -1 AS inner_product FROM items;

# sleep disorder embedding and the top related products
        
SELECT  product_name , 1 - (pgvector_desc  <=> '[-0.001116385916247964, 0.011351925320923328, 0.03599287569522858, 0.08694617450237274, 0.0728675052523613, 0.03704797849059105, 0.0017912955954670906, -0.017643988132476807, 0.020942777395248413, -0.03060850314795971, -0.10427874326705933, 0.015400598756968975, 0.04490342363715172, 0.005858350079506636, 0.05815313756465912, 0.05928604304790497, 0.10038640350103378, 0.12186222523450851, 0.05040017142891884, -0.03586195409297943, 0.04053284600377083, 0.007071777246892452, 0.11314128339290619, 0.10091838985681534, 0.007381369359791279, 0.04375826194882393, -0.020884303376078606, -0.07376522570848465, 0.014930046163499355, -0.0725046843290329, -0.009256713092327118, -0.03061305731534958, -0.017809178680181503, -0.06776256114244461, -0.010450993664562702, 0.02571870945394039, 0.03983330726623535, 0.005530737806111574, -0.07501350343227386, 0.020069800317287445, 0.09553346037864685, -0.0037887843791395426, 0.015625249594449997, -0.06338154524564743, -0.03532884269952774, 0.020553868263959885, -0.024887148290872574, -0.010515172965824604, -0.0008879676461219788, 0.05647752806544304, -0.04994891956448555, -0.019444888457655907, -0.06161300092935562, -0.0010026576928794384, 0.037769049406051636, 0.008909671567380428, -0.06272865831851959, 0.03650934621691704, 0.09057224541902542, 0.07297985255718231, 0.01635287143290043, -0.032214242964982986, 0.0005167630151845515, -0.052337173372507095, 0.0006575520383194089, 0.09314370900392532, -0.07076027989387512, 0.03486306965351105, -0.01163535751402378, -0.020003657788038254, -0.15133050084114075, -0.07612647861242294, 0.053053610026836395, -0.006660004612058401, -0.04470507428050041, 0.04485038295388222, 0.08474665880203247, -0.05494812875986099, 0.044450607150793076, 0.02318212389945984, -0.021821126341819763, 0.023516187444329262, 0.004705832339823246, 0.04111756011843681, 0.033882688730955124, 0.006076698657125235, 0.07312247902154922, 0.013055164366960526, -0.07023976743221283, -0.01827181689441204, 0.11453347653150558, -0.00736868055537343, -0.03019055910408497, 0.02854483388364315, 0.02961546741425991, -0.05464687943458557, -0.02281211130321026, -0.018910367041826248, -0.036782752722501755, 0.008692016825079918, 0.0055212355218827724, -0.009778455831110477, 0.038491830229759216, -0.09110603481531143, -0.017283476889133453, 0.011053444817662239, 0.00683192303404212, -0.06626822054386139, 0.05074586346745491, 0.017297755926847458, -0.06119094043970108, -0.024174433201551437, -0.12073522806167603, 0.04160156473517418, -0.01450885646045208, 0.03151577711105347, 0.08667873591184616, 0.08202902227640152, 0.0767158567905426, 0.007211436051875353, 0.015887867659330368, 0.004409650340676308, 0.1337094008922577, -0.1126699298620224, 0.013678380288183689, -0.025650573894381523, -0.033583831042051315, -2.1185817135435006e-33, -0.01789998449385166, -0.0009335536160506308, -0.03140999749302864, 0.06889805942773819, 0.028364451602101326, -0.021190449595451355, -0.05196112394332886, 0.07636081427335739, 0.05689164623618126, 0.03139481320977211, -0.08646082133054733, 0.02378847263753414, -0.0262789037078619, 0.01777743548154831, 0.014565474353730679, -0.05508917570114136, -0.04533223807811737, -0.032609354704618454, -0.002735150745138526, -0.03771437704563141, -0.05100410059094429, 0.014611201360821724, 0.039291176944971085, 0.018054194748401642, -0.017392808571457863, -0.043398045003414154, 0.0028125529643148184, 0.008852754719555378, -0.01943930797278881, -0.012852495536208153, 0.019471053034067154, -0.030325062572956085, 0.019060924649238586, -0.0106613514944911, -0.02563602104783058, 0.04477987065911293, -0.05251399800181389, -0.01214547362178564, -0.0328519307076931, 0.013345387764275074, -0.024734022095799446, 0.08554138243198395, 0.0006405756575986743, 0.029314089566469193, 0.04702557995915413, -0.005079057067632675, -0.00468144565820694, 0.026670828461647034, 0.030266694724559784, -0.059530459344387054, -0.006802476476877928, -0.0337224118411541, -0.05303002521395683, -0.09569459408521652, -0.09051201492547989, -0.039994094520807266, -0.024017034098505974, 0.07890037447214127, 0.04424881562590599, 0.0731746181845665, -0.07023254781961441, 0.0038393731229007244, 0.03473755717277527, -0.07949185371398926, 0.001169782248325646, -0.042662959545850754, -0.013641256839036942, -0.06959735602140427, -0.13294947147369385, -0.05458685755729675, 0.08453711867332458, 0.026064543053507805, 0.10663217306137085, 0.01696438156068325, -0.014264654368162155, -0.00045713671715930104, 0.039334096014499664, -0.033290620893239975, -0.07348430156707764, -0.08393971621990204, 0.08986973017454147, -0.01693282276391983, 0.018380818888545036, -0.004214055836200714, 0.011762472800910473, -0.042806852608919144, -0.1355278640985489, 0.10078036785125732, 0.018894577398896217, -0.037852149456739426, -0.10178788751363754, -0.085985466837883, 0.06549772620201111, -0.021626511588692665, -0.09555728733539581, 2.0307342656416663e-33, 0.014384879730641842, -0.17038701474666595, 0.03671305999159813, 0.023860851302742958, 0.05994502454996109, -0.016644824296236038, 0.0069250729866325855, -0.09565161913633347, -0.05216522514820099, -0.004555728752166033, 0.028448427096009254, -0.054546184837818146, 0.06452694535255432, -0.018005162477493286, 0.05654614418745041, -0.002313628327101469, 0.07312440872192383, -0.003078560344874859, -0.0355101153254509, 0.05472614988684654, -0.0004033855511806905, 0.0893176943063736, 4.175817230134271e-05, -0.049952272325754166, 0.013625887222588062, 0.03991240635514259, 0.015561714768409729, 0.08958620578050613, 0.07238822430372238, -0.017566939815878868, -0.0095139741897583, -0.0457284078001976, -0.04032400622963905, -0.0036802971735596657, 0.01167611125856638, -0.003275464056059718, 0.03787316381931305, -0.03338265046477318, -0.03977523744106293, -0.0494418665766716, 0.07753187417984009, -0.006300440523773432, 0.035462986677885056, -0.022144485265016556, 0.07793504744768143, 0.02504066564142704, -0.11840253323316574, -0.0707940086722374, -0.03592630475759506, 0.0632622241973877, 0.04487268626689911, -0.03996414691209793, -0.05636235699057579, 0.02704201452434063, -0.03184625506401062, -0.04700097814202309, -0.0044878809712827206, -0.07239657640457153, -0.03307582810521126, 0.006629677955061197, -0.05714622512459755, 0.006765689235180616, 0.0007627361919730902, -0.014806809835135937, 0.05771700665354729, 0.054637420922517776, -0.0013387559447437525, -0.042931973934173584, 0.016182154417037964, -0.0445282980799675, 0.0649542510509491, -0.005392458289861679, 0.007722277194261551, 0.057873815298080444, -0.023138370364904404, 0.013451107777655125, 0.07633383572101593, 0.008776390925049782, 0.006266359239816666, -0.05416189506649971, 0.014336925931274891, -0.09621136635541916, 0.0039061405695974827, -0.034702446311712265, -0.04692434147000313, 0.0036894683726131916, 0.08716418594121933, 0.02544056810438633, 0.02785968780517578, 0.028009671717882156, -0.015800347551703453, -0.010839646682143211, -0.050980180501937866, 0.09160833060741425, 0.06887901574373245, -1.7038951583003836e-08, 0.03856843709945679, -0.09642808884382248, 0.053561605513095856, 0.11815490573644638, -0.06953179836273193, -0.09118229150772095, -0.03828205540776253, -0.009008403867483139, -0.0491105280816555, -0.04982569441199303, -0.006631508469581604, -0.04623370245099068, 0.057711850851774216, -0.011777093634009361, 0.020827440544962883, -0.03993580490350723, -0.00830959901213646, 0.11604738235473633, 0.022812768816947937, -0.023467937484383583, -0.014253541827201843, 0.02850654348731041, 0.03316304832696915, -0.051094647496938705, 0.09293601661920547, 0.01521200593560934, 0.06099575757980347, 0.04129581153392792, 0.06205659359693527, -0.06715942919254303, 0.031493473798036575, -0.012182790786027908, 0.04830077663064003, -0.05850281938910484, -0.008007011376321316, -0.05775606632232666, 0.10070350766181946, -0.029236895963549614, -0.043228860944509506, 0.06324387341737747, -0.0303302314132452, -0.021939095109701157, -0.05177733674645424, 0.023954540491104126, 0.012172557413578033, -0.06251956522464752, 0.04158094897866249, -0.033388279378414154, -0.02578604221343994, 0.06234245002269745, 0.04791055619716644, -0.012732448987662792, 0.042130112648010254, -0.05240970849990845, -0.0319107286632061, 0.014210616238415241, 0.003427988849580288, -0.04765235260128975, 0.011896793730556965, -0.040358319878578186, 0.03338722884654999, -0.008784588426351547, 0.023860814049839973, 0.03182549402117729]') AS cosine_similarity FROM products p  order by cosine_similarity desc;


```

