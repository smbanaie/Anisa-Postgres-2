### [Pg Vector Intro](https://github.com/pgvector/pgvector) 

- create the vector extension in `cbd_store` db :

  ```sql
  -- init.sql
  CREATE EXTENSION vector;
  
  
  ```

  

- create the product table :

  ```sql
  CREATE TABLE product (
      id SERIAL PRIMARY KEY,
      vector_description vector, 
      promised_ce INT,
      stock_level INT,
      category VARCHAR(255),
      title VARCHAR(255),
      brand VARCHAR(255),
      description TEXT
  );
  ```

  

- insert some data : 

  ```sql 
  INSERT INTO product (vector_description, promised_ce, stock_level, category, title, brand, description)
  VALUES 
      ('{1.2, 3.4, 5.6}', 24, 100, 'Electronics', 'Laptop', 'BrandX', 'Powerful laptop for gaming and productivity.'),
      ('{0.8, 2.6, 4.9}', 12, 50, 'Clothing', 'T-shirt', 'FashionCo', 'Comfortable cotton t-shirt for everyday wear.'),
      ('{2.1, 4.3, 6.5}', 36, 80, 'Home & Kitchen', 'Coffee Maker', 'KitchenMaster', 'Automatic coffee maker for brewing fresh coffee.'),
      ('{1.5, 3.8, 7.2}', 48, 120, 'Electronics', 'Smartphone', 'TechGiant', 'Latest smartphone with high-resolution display and powerful processor.'),
      ('{0.9, 2.4, 5.7}', 18, 60, 'Clothing', 'Jeans', 'DenimCo', 'Classic denim jeans with a comfortable fit.'),
      ('{2.3, 4.6, 8.9}', 64, 150, 'Home & Kitchen', 'Blender', 'KitchenMaster', 'Powerful blender for making smoothies and sauces.'),
      ('{1.8, 3.1, 6.4}', 30, 70, 'Electronics', 'Tablet', 'TechGiant', 'Versatile tablet for work and entertainment.'),
      ('{0.7, 2.9, 4.2}', 10, 40, 'Clothing', 'Sweater', 'FashionCo', 'Cozy sweater for chilly days.'),
      ('{2.5, 4.8, 7.1}', 42, 90, 'Home & Kitchen', 'Rice Cooker', 'KitchenMaster', 'Automatic rice cooker for perfectly cooked rice every time.'),
      ('{1.3, 3.6, 5.9}', 28, 80, 'Electronics', 'Smart Watch', 'TechGiant', 'Smart watch with fitness tracking and notification features.');
  
  
  or 
  
  
  
  INSERT INTO product (vector_description, promised_ce, stock_level, category, title, brand, description)
  VALUES
      (ARRAY[1.2, 3.4, 5.6], 24, 100, 'Electronics', 'Laptop', 'BrandX', 'Powerful laptop for gaming and productivity.'),
      (ARRAY[0.8, 2.6, 4.9], 12, 50, 'Clothing', 'T-shirt', 'FashionCo', 'Comfortable cotton t-shirt for everyday wear.'),
      (ARRAY[2.1, 4.3, 6.5], 36, 80, 'Home & Kitchen', 'Coffee Maker', 'KitchenMaster', 'Automatic coffee maker for brewing fresh coffee.'),
      (ARRAY[1.5, 3.8, 7.2], 48, 120, 'Electronics', 'Smartphone', 'TechGiant', 'Latest smartphone with high-resolution display and powerful processor.'),
      (ARRAY[0.9, 2.4, 5.7], 18, 60, 'Clothing', 'Jeans', 'DenimCo', 'Classic denim jeans with a comfortable fit.'),
      (ARRAY[2.3, 4.6, 8.9], 64, 150, 'Home & Kitchen', 'Blender', 'KitchenMaster', 'Powerful blender for making smoothies and sauces.'),
      (ARRAY[1.8, 3.1, 6.4], 30, 70, 'Electronics', 'Tablet', 'TechGiant', 'Versatile tablet for work and entertainment.'),
      (ARRAY[0.7, 2.9, 4.2], 10, 40, 'Clothing', 'Sweater', 'FashionCo', 'Cozy sweater for chilly days.'),
      (ARRAY[2.5, 4.8, 7.1], 42, 90, 'Home & Kitchen', 'Rice Cooker', 'KitchenMaster', 'Automatic rice cooker for perfectly cooked rice every time.'),
      (ARRAY[1.3, 3.6, 5.9], 28, 80, 'Electronics', 'Smart Watch', 'TechGiant', 'Smart watch with fitness tracking and notification features.');
  
  ```

  

- `select * from product`



## Getting Started

Enable the extension (do this once in each database where you want to use it)

```
CREATE EXTENSION vector;
```



Create a vector column with 3 dimensions

```
CREATE TABLE items (id bigserial PRIMARY KEY, embedding vector(3));
```



Insert vectors

```
INSERT INTO items (embedding) VALUES ('[1,2,3]'), ('[4,5,6]');
```



Get the nearest neighbors by L2 distance

```
SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;
```



Also supports inner product (`<#>`) and cosine distance (`<=>`)

Note: `<#>` returns the negative inner product since Postgres only supports `ASC` order index scans on operators

## Storing

Create a new table with a vector column

```
CREATE TABLE items (id bigserial PRIMARY KEY, embedding vector(3));
```



Or add a vector column to an existing table

```
ALTER TABLE items ADD COLUMN embedding vector(3);
```



Insert vectors

```
INSERT INTO items (embedding) VALUES ('[1,2,3]'), ('[4,5,6]');
```



Upsert vectors

```
INSERT INTO items (id, embedding) VALUES (1, '[1,2,3]'), (2, '[4,5,6]')
    ON CONFLICT (id) DO UPDATE SET embedding = EXCLUDED.embedding;
```



Update vectors

```
UPDATE items SET embedding = '[1,2,3]' WHERE id = 1;
```



Delete vectors

```
DELETE FROM items WHERE id = 1;
```



## Querying

Get the nearest neighbors to a vector

```
SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;
```



Get the nearest neighbors to a row

```
SELECT * FROM items WHERE id != 1 ORDER BY embedding <-> (SELECT embedding FROM items WHERE id = 1) LIMIT 5;
```



Get rows within a certain distance

```
SELECT * FROM items WHERE embedding <-> '[3,1,2]' < 5;
```



Note: Combine with `ORDER BY` and `LIMIT` to use an index

#### Distances

Get the distance

```
SELECT embedding <-> '[3,1,2]' AS distance FROM items;
```



For inner product, multiply by -1 (since `<#>` returns the negative inner product)

```
SELECT (embedding <#> '[3,1,2]') * -1 AS inner_product FROM items;
```



For cosine similarity, use 1 - cosine distance

```
SELECT 1 - (embedding <=> '[3,1,2]') AS cosine_similarity FROM items;
```



#### Aggregates

Average vectors

```
SELECT AVG(embedding) FROM items;
```



Average groups of vectors

```
SELECT category_id, AVG(embedding) FROM items GROUP BY category_id;
```



### Practical Samples

```-- Add a new column named vector_description
    ALTER TABLE products ADD COLUMN pgvector_desc vector;
```

- create the embedding of each `seo_desc` using OpenAI/GPT4All/ ...
- store the embedding and start querying ... 





```sql

SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;



SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;


SELECT embedding <-> '[3,1,2]' AS distance FROM items;


SELECT (embedding <#> '[3,1,2]') * -1 AS inner_product FROM items;

# sleep disorder embedding and the top related products
        
SELECT  product_name , 1 - (pgvector_desc  <=> '[0.05171085521578789, 0.020804887637495995, -0.01848127320408821, 0.09907352179288864, 0.03714098781347275, 0.04775248467922211, 0.045992281287908554, -0.007342045661062002, 0.04063361883163452, -0.015501482412219048, -0.07530377805233002, -0.009261678904294968, 0.04551692306995392, 0.03131993114948273, 0.012250666506588459, 0.06782738119363785, -0.016594134271144867, 0.004965204745531082, 0.08775649219751358, 0.030507072806358337, 0.04616709053516388, 0.07755618542432785, 0.13209494948387146, -0.0002323106600670144, 0.011323911137878895, -0.0018015913665294647, 0.07060040533542633, -0.11597049236297607, 0.012958984822034836, -0.04358606040477753, -0.06667328625917435, 0.03723859786987305, -0.06636494398117065, -0.047362301498651505, 0.07492321729660034, 0.018169483169913292, 0.04366739094257355, 0.0036569833755493164, -0.0567118301987648, 0.03149764612317085, 0.06622910499572754, -0.050135791301727295, 0.026757346466183662, -0.06889844685792923, -0.09652099013328552, 0.017671307548880577, 0.0038704737089574337, -0.017510052770376205, -0.026732048019766808, 0.06678733974695206, 0.05496643856167793, -0.03196308761835098, -0.015638023614883423, -0.05989970266819, 0.03086959570646286, -0.021927058696746826, -0.0631554052233696, 0.0697936862707138, 0.04845935478806496, 0.07263002544641495, -0.05148715525865555, 0.055675145238637924, 0.043336622416973114, -0.06656693667173386, 0.07631111890077591, 0.10756529122591019, -0.07146698981523514, 0.03686738386750221, 0.04175916314125061, -0.023646993562579155, -0.09412356466054916, -0.04729994386434555, 0.023145155981183052, -0.01552071887999773, 0.04083733633160591, -0.017744598910212517, 0.06251943856477737, -0.07167473435401917, 0.07654526084661484, -0.02344943955540657, 0.013126136735081673, 0.058889344334602356, 0.01898478902876377, -0.044572874903678894, 0.059898536652326584, 0.05972481518983841, 0.09992723912000656, 0.050033826380968094, -0.04905366897583008, 0.01434266846626997, 0.06477982550859451, -0.06269664317369461, -0.0315822996199131, 0.01343537773936987, 0.05142484977841377, 0.005709393881261349, -0.004953387659043074, -0.015865346416831017, -0.06667899340391159, 0.15597304701805115, -0.0005947610479779541, 0.030398624017834663, 0.06480180472135544, -0.006952980067580938, -0.036986567080020905, 0.04774240776896477, 0.01527128554880619, -0.07041053473949432, -0.08915656805038452, -0.03546451777219772, -0.026618413627147675, 0.005898041184991598, 0.0018373384373262525, 0.049379460513591766, 0.05642746761441231, 0.0039033456705510616, -0.021075507625937462, 0.04504017531871796, 0.02688189409673214, 0.0416710264980793, 0.0166151262819767, -0.0029503381811082363, 0.05374550819396973, -0.10780277848243713, -0.03252820670604706, -0.04780464619398117, -0.16607284545898438, -4.5725591486834625e-34, 0.02033006027340889, -0.022699829190969467, -0.06814824044704437, 0.013119027949869633, -0.0002226607466582209, -0.043509237468242645, -0.045028477907180786, 0.042583923786878586, 0.009594470262527466, 0.041773464530706406, -0.07109260559082031, -0.07355720549821854, 0.03321186825633049, -0.057204876095056534, 0.07474066317081451, 0.010069064795970917, 0.025958482176065445, 0.034668922424316406, -0.04941677674651146, -0.014954810962080956, -0.0165916346013546, 0.09603114426136017, 0.07313429564237595, 0.050042036920785904, -0.0358179472386837, -0.03258088231086731, 0.010310771875083447, -0.022289752960205078, 0.005690591875463724, 0.015270372852683067, 0.0484241358935833, -0.009337135590612888, -0.05884586274623871, -0.05118783563375473, 0.06240801885724068, 0.07018759846687317, 0.07001188397407532, 0.03399762883782387, -0.06666551530361176, -0.04097574204206467, -0.08445620536804199, 0.06439156085252762, -0.049645014107227325, 0.02832333743572235, -0.012252600863575935, 0.03440941497683525, 0.07199345529079437, 0.024392275139689445, -0.02964336797595024, -0.020013751462101936, 0.021141417324543, -0.04456141218543053, -0.08552699536085129, -0.07705242931842804, -0.05406523868441582, -0.0357605405151844, -0.01313907653093338, -0.0014450540766119957, 0.06028129905462265, 0.07802744209766388, 0.03491969406604767, 0.010874559171497822, 0.05914302542805672, -0.06511731445789337, 0.03616003319621086, -0.013626707717776299, 0.03612980619072914, -0.09005403518676758, -0.049003612250089645, -0.06792198121547699, 0.06515570729970932, -0.0622195340692997, 0.03280980512499809, 0.03021222911775112, 0.0047025131061673164, -0.04279988259077072, 0.031290825456380844, -0.017806021496653557, -0.091311514377594, -0.04059215635061264, 0.09816909581422806, -0.03252890333533287, -0.02333434671163559, -0.09078141301870346, 0.013373359106481075, 0.002781769959256053, -0.09338237345218658, 0.07925086468458176, -0.0809716060757637, -0.004222686868160963, -0.03392980992794037, -0.037349846214056015, 0.10517921298742294, -0.009304312989115715, -0.08915245532989502, 9.842911029469228e-34, -0.037285275757312775, -0.09205272793769836, -0.0025181148666888475, -0.08885788172483444, 0.038992222398519516, -0.007745751179754734, -0.023425312712788582, -0.0658254325389862, -0.01066633965820074, 0.03988424688577652, 0.07874345779418945, -0.018465962260961533, 0.010947254486382008, 0.00972522422671318, 0.06687673926353455, -0.04627479240298271, 0.008639869280159473, -0.026594476774334908, -0.015420124866068363, 0.032424140721559525, 0.03507337346673012, 0.044468678534030914, -0.029758386313915253, -0.07026087492704391, 0.060886450111866, 0.09425375610589981, -0.047062624245882034, 0.09944481402635574, 0.014708227477967739, -0.018851827830076218, 0.0466122105717659, -0.025266701355576515, -0.03244152292609215, 0.01740301214158535, 0.012932488694787025, -0.006955922581255436, 0.0018510657828301191, -0.0007725923787802458, -0.013999970629811287, -0.08350349217653275, 0.04760767146945, -0.027363013476133347, 0.03537003695964813, -0.007149640936404467, 0.12035267800092697, 0.02287902683019638, -0.09087327122688293, -0.013591375201940536, 0.009990568272769451, -0.03354156017303467, 0.021854104474186897, -0.009871287271380424, -0.014578668400645256, 0.014480766840279102, -0.08478249609470367, -0.016632985323667526, -0.10907101631164551, -0.021984759718179703, -0.005468409974128008, 0.007316578179597855, 0.01067314948886633, -0.054844241589307785, -0.01110740564763546, -0.004582291468977928, 0.06397710740566254, -0.005689364392310381, 0.008016809821128845, -0.08517296612262726, 0.050414010882377625, -0.04270604997873306, 0.05068139731884003, -0.02078191749751568, -0.03209671378135681, 0.12003165483474731, -0.045084260404109955, -0.03381955251097679, -0.005676063243299723, 0.011471066623926163, 0.012448964640498161, -0.08447309583425522, -0.023276906460523605, -0.06253767013549805, 0.055438317358493805, 0.04218565300107002, -0.04803217574954033, -0.028874780982732773, 0.13257566094398499, -0.021982181817293167, 0.07862056791782379, -0.012524111196398735, -0.04053955525159836, 0.003370341146364808, -0.06952589005231857, 0.02673725038766861, 0.03314393013715744, -1.250997261337261e-08, 0.008117187768220901, -0.10847748070955276, -0.017313681542873383, 0.05038432404398918, -0.039676155894994736, -0.011628421023488045, -0.0069281673058867455, -0.013725919649004936, -0.062479015439748764, -0.000698214746080339, -0.051308006048202515, -0.05807068943977356, 0.07092931866645813, -0.06752683967351913, -0.006516522262245417, -0.01849948614835739, -0.05335158109664917, 0.13818329572677612, 0.024799777194857597, -0.04871179535984993, 0.06966450810432434, -0.0063318214379251, 0.03516112267971039, -0.011120420880615711, 0.05490892007946968, 0.010222735814750195, -0.0041351281106472015, -0.02961333654820919, -0.0035916834603995085, -0.07497987151145935, 0.03568337485194206, 0.029500162228941917, 0.01931268349289894, 0.0018207058310508728, -0.07178745418787003, -0.05690933018922806, 0.08190567046403885, -0.07472021132707596, 0.014767642132937908, 0.059446197003126144, 0.003516444703564048, 0.021604059264063835, 0.03227623552083969, -0.020754719153046608, -0.019176047295331955, -0.01897045224905014, 0.0836961418390274, -0.03508567810058594, 0.03651267662644386, 0.03240727633237839, 0.022932304069399834, -0.03847433626651764, 0.021172966808080673, 0.00033637185697443783, -0.034698836505413055, 0.013224671594798565, 0.023486144840717316, 0.005390857812017202, -0.0015483571914955974, -0.06460622698068619, 0.059107594192028046, 0.009724210016429424, -0.026158692315220833, -0.014343255199491978]') AS cosine_similarity FROM products p  order by cosine_similarity desc;


```

